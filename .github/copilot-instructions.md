# Copilot Instructions for Mary Esther Bingo

- **Framework & runtime:** Nuxt 3 + H3 server; TypeScript, Tailwind, Pinia. Server APIs live in `server/api/**`, services in `server/services/**`, Prisma client in `server/db/client.ts` (SQLite by default).
- **Data model:** Prisma schema (`prisma/schema.prisma`) covers users, sessions, MIC shift records, incidents, restricted players, audit logs, etc. Sessions store `token_hash` (SHA-256 of the auth token) with expiry; Prisma migrations live in `prisma/migrations/**`.
- **Auth flow:** `/api/auth/login` validates `username`/`password` (min 8 chars) via `authService.verifyPassword` (argon2), rate-limited per IP. On success, sets `auth_token` (httpOnly) + `csrf_token` cookies (expires with session). `/api/auth/logout` revokes the session and clears cookies.
- **Middleware:** `server/middleware/auth.ts` attaches `event.context.user` when `auth_token` is valid; `server/middleware/csrf.ts` enforces double-submit CSRF on all POST/PUT/PATCH/DELETE except login. Mutations must send `x-csrf-token` matching the `csrf_token` cookie. Auth errors should use `createError({ statusCode: 401|403, message })` for predictable client handling.
- **Frontend CSRF contract:** Use `useCsrf().getHeaders()` + `credentials: "include"` on every mutating `$fetch`/`useFetch`. Pattern: `await $fetch(url, { method: "POST", body, headers: getHeaders(), credentials: "include" })`. Examples: `pages/admin/index.vue`, `pages/admin/mic/shifts.vue`, `stores/ops.ts`. Do **not** bypass this header for admin APIs.
- **Routing guards:** Admin pages declare `definePageMeta({ middleware: ["auth", "role"], roles: ["MIC"|"OWNER"|"CHARITY"] })` and render via `components/admin/AdminShell.vue` with `@logout` wired to `/api/auth/logout` (with CSRF header). Normalize roles with `utils/roles.ts`.
- **Admin UI patterns:** Reuse shell/sidebar components in `components/admin/**`; MIC tools live in `components/admin/mic/**` and corresponding pages under `pages/admin/mic/**`. Keep forms using `$fetch` with credentials + CSRF headers; prefer `ref` state over Vuex/Pinia here.
- **API patterns:** Validate inputs with Zod; throw `createError({ statusCode, message })` on failure. Keep business logic in services (e.g., `auth.service.ts`, `shiftRecords.service.ts`), not inside handlers. Use `rateLimiter` for abuse-sensitive routes (login/contact). Attach authenticated users via middleware rather than re-reading cookies in handlers.
- **File-backed config:** Public content (business, pricing, schedule, specials) still resides in `server/data/*.json`; use `server/utils/storage.ts` helpers to read/write consistently (handles locking/paths).
- **Dev workflow:** `npm install` runs `scripts/setup-db.js` + `nuxt prepare` (creates SQLite DB, runs Prisma generate/push/seed). Start dev with `npm run dev`. Lint/typecheck with `npm run lint` and `npm run typecheck`.
- **Build/run:** `npm run build` then `npm run start:local` (development mode for cookies without `Secure`). `npm run start:server` runs the built server; avoid `npm run start` for APIs (static only).
- **DB utilities:** `npm run setup:db` / `npm run db:setup` reprovision; `npm run check:db` pings the DB via Prisma. Default admin credentials come from `prisma/seed.js` (`admin` / `admin123`).
- **Testing & verification:** Playwright scripts in `verification/` (e.g., `npm run verify:admin` which runs `verification/verify_admin_console.py`). Ensure dev server running at `http://localhost:3000` before executing.
- **Lint/type safety:** ESLint + Prettier + vue-tsc; config lives in `package.json`/`tsconfig.json`. Prefer TypeScript types from `types/` (e.g., `types/admin.ts`, `types/ops-schema.ts`).
- **Error handling/logging:** Keep stack traces out of production errors; login handler logs errors server-side. Maintain consistent `message` strings for frontend checks; admin UI often checks plain `message`.
- **Styling/UI:** Tailwind + custom emerald/gold theme. Reuse UI atoms in `components/ui/` and admin shells/sidebars in `components/admin/**`; prefer `BaseButton`, `BaseCard`, `BaseModal` before adding new primitives.
- **Edge cases:** Auth cookies set `secure` in production; use `start:local` for HTTP testing. CSRF middleware blocks admin mutations without `x-csrf-token`; always include the header when adding new API calls.
- **Good files to reference:** `server/api/auth/login.post.ts`, `server/middleware/csrf.ts`, `composables/useCsrf.ts`, `stores/ops.ts`, `pages/admin/mic/shifts.vue`, `scripts/setup-db.js`, `README.md`, `server/services/auth.service.ts`, `server/utils/rateLimiter.ts`.
